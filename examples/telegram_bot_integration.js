/**
 * ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ ExcelParser Ñ Telegram Ð±Ð¾Ñ‚Ð¾Ð¼
 * Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚, ÐºÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€ÑÐµÑ€ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Excel Ñ„Ð°Ð¹Ð»Ð¾Ð²
 */

import { Telegraf } from 'telegraf';
import ExcelParser from '../src/parsers/excelParser.js';

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð° (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° ÑÐ²Ð¾Ð¹ Ñ‚Ð¾ÐºÐµÐ½)
const bot = new Telegraf('YOUR_BOT_TOKEN_HERE');

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.start((ctx) => {
  ctx.reply(
    'ðŸšš Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð±Ð¾Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð³Ñ€ÑƒÐ·Ð¾Ð²!\n\n' +
    'ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Excel Ñ„Ð°Ð¹Ð» Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ñ… Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸.'
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
bot.help((ctx) => {
  ctx.reply(
    'ðŸ“‹ **Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:**\n\n' +
    '/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n' +
    '/help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ\n' +
    '/test - ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€ÑÐµÑ€\n\n' +
    'ðŸ“ **ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Excel Ñ„Ð°Ð¹Ð»** Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ñ….'
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /test
bot.command('test', (ctx) => {
  // Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
  const testRow = [
    "01.09.25_77_00Ñ‡_Ð’Ð˜ÐŸ_19",
    "3.32 ÐºÑƒÐ±.Ð¼/871 ÐºÐ³/1.010 Ð¼/ÐÐµÑ‚",
    "13908.Ð—Ð°ÐºÐ°Ð·Ð°Ð½Ð¾.01\\.09\\.2025 00:00:00.ÐšÑƒÐ»ÑƒÑˆÐ¾Ð² ÐœÐ°Ñ€Ð°Ñ‚ Ð¨Ð°Ð¹Ð»Ð¾Ð¾Ð±Ð°ÐµÐ²Ð¸Ñ‡........01\\.09\\.2025 01:30:00..202",
    'ÐžÐžÐž "Ð“Ð Ð£Ð— Ð¡Ð•Ð Ð’Ð˜Ð¡"'
  ];
  
  const parsedData = ExcelParser.parseRow(testRow);
  
  if (ExcelParser.validate(parsedData)) {
    const formatted = ExcelParser.format(parsedData);
    ctx.reply(formatted, { parse_mode: 'Markdown' });
  } else {
    ctx.reply('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…');
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
bot.on('document', async (ctx) => {
  const document = ctx.message.document;
  
  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Excel Ñ„Ð°Ð¹Ð»
  if (document.mime_type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
    ctx.reply('ðŸ“Š ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ Excel Ñ„Ð°Ð¹Ð». ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽ...');
    
    try {
      // Ð—Ð´ÐµÑÑŒ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° Excel Ñ„Ð°Ð¹Ð»Ð°
      // Ð”Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      await processExcelFile(ctx, document);
      
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°:', error);
      ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ„Ð°Ð¹Ð»Ð°');
    }
  } else {
    ctx.reply('âŒ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Excel Ñ„Ð°Ð¹Ð» (.xlsx)');
  }
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Excel Ñ„Ð°Ð¹Ð»Ð°
async function processExcelFile(ctx, document) {
  // Ð’ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸ Ð·Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚:
  // 1. Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° Ð¿Ð¾ file_id
  // 2. ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Excel Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, xlsx)
  // 3. ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· ExcelParser
  
  // Ð”Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
  const mockExcelData = [
    [
      "01.09.25_77_00Ñ‡_Ð’Ð˜ÐŸ_19",
      "3.32 ÐºÑƒÐ±.Ð¼/871 ÐºÐ³/1.010 Ð¼/ÐÐµÑ‚",
      "13908.Ð—Ð°ÐºÐ°Ð·Ð°Ð½Ð¾.01\\.09\\.2025 00:00:00.ÐšÑƒÐ»ÑƒÑˆÐ¾Ð² ÐœÐ°Ñ€Ð°Ñ‚ Ð¨Ð°Ð¹Ð»Ð¾Ð¾Ð±Ð°ÐµÐ²Ð¸Ñ‡........01\\.09\\.2025 01:30:00..202",
      'ÐžÐžÐž "Ð“Ð Ð£Ð— Ð¡Ð•Ð Ð’Ð˜Ð¡"'
    ],
    [
      "02.09.25_78_12Ñ‡_Ð¡Ð¢ÐÐÐ”ÐÐ Ð¢_25",
      "2.15 ÐºÑƒÐ±.Ð¼/450 ÐºÐ³/0.850 Ð¼/Ð”Ð°",
      "13909.Ð—Ð°ÐºÐ°Ð·Ð°Ð½Ð¾.02\\.09\\.2025 12:00:00.Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡........02\\.09\\.2025 14:30:00..203",
      'ÐžÐžÐž "Ð“Ð Ð£Ð— Ð¡Ð•Ð Ð’Ð˜Ð¡"'
    ]
  ];
  
  let processedCount = 0;
  let errorCount = 0;
  
  for (const row of mockExcelData) {
    const parsedData = ExcelParser.parseRow(row);
    
    if (ExcelParser.validate(parsedData)) {
      const formatted = ExcelParser.format(parsedData);
      await ctx.reply(formatted, { parse_mode: 'Markdown' });
      processedCount++;
    } else {
      await ctx.reply(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÑÑ‚Ñ€Ð¾ÐºÐµ: ${row.join(' | ')}`);
      errorCount++;
    }
    
    // ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼Ð¸
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  // Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
  await ctx.reply(
    `ðŸ“Š **ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!**\n\n` +
    `âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾: ${processedCount}\n` +
    `âŒ ÐžÑˆÐ¸Ð±Ð¾Ðº: ${errorCount}\n\n` +
    `Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐµÐ½Ñ‹ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ.`
  );
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', (ctx) => {
  ctx.reply(
    'ðŸ“ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Excel Ñ„Ð°Ð¹Ð» Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ñ… Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸.\n\n' +
    'Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /test Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ð°Ñ€ÑÐµÑ€Ð°.'
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð¾Ñ‚Ð°:', err);
  ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð±Ð¾Ñ‚Ð°');
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
bot.launch()
  .then(() => {
    console.log('ðŸš€ Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
    console.log('ðŸ“± Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ @BotFather Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°');
    console.log('ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð±Ð¾Ñ‚Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸');
  })
  .catch((error) => {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°:', error);
  });

// Graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));

export default bot;
